for(let key of Object.keys(globalUtils))window[key]=globalUtils[key];window.defaultConfig={"wiki.theme":"auto"},Object.defineProperty(window,"query",{get:()=>new URLSearchParams(window.location.search)});let userPopup,quickBlockModal,quickBlockGroupSelect,quickBlockMode,quickBlockTarget,quickBlockNote,quickBlockDuration,settingModal,settingModalContent,captcha,captchaLoaded;const captchaLock=[];function contentLoadedHandler(){content=document.getElementById("content"),progressBar=document.getElementById("progress-bar"),userPopup=document.getElementById("userpopup"),quickBlockModal=document.getElementById("quickblock-modal"),quickBlockGroupSelect=document.getElementById("quickblock-group-select"),quickBlockMode=document.getElementById("quickblock-mode"),quickBlockTarget=document.getElementById("quickblock-target"),quickBlockNote=document.getElementById("quickblock-note"),quickBlockDuration=document.getElementById("quickblock-duration"),settingModal=document.getElementById("setting-modal"),settingModalContent=document.getElementById("setting-modal-content");let e=document.getElementsByClassName("setting-input");for(let t of e){let a="checkbox"===t.type,r=t.dataset.default;a?(defaultConfig[t.id]="true"===r,t.checked=State.getLocalConfig(t.id)):(defaultConfig[t.id]=r,t.value=State.getLocalConfig(t.id))}}document.addEventListener("alpine:initialized",()=>{contentLoadedHandler(),setupDocument()});let currentUrl=location.href;function plainAlert(e){let t=new DOMParser().parseFromString(e,"text/html"),a=t.body.textContent,r=document.getElementsByClassName("thetree-error-alert"),n=!1;for(let o of r){if(!e){o.hidden=!0;continue}let s=o.parentElement.parentElement.parentElement.parentElement;if(s.classList.contains("thetree-modal")&&!s.classList.contains("thetree-modal-open"))continue;let l=o.getElementsByClassName("thetree-alert-content-text")[0];l&&(o.hidden=!1,l.innerHTML=t.body.innerHTML,n=!0)}!n&&e&&alert(a)}window.addEventListener("popstate",async e=>{let t=currentUrl;currentUrl=location.href;let a=t.split("#")[0]===currentUrl.split("#")[0];if("function"==typeof window.beforePopstate){let r=await window.beforePopstate(a);if(!r)return history.pushState({},null,t)}a?focusAnchor():await movePage(location.href,!1,t)});const aClickHandler=async e=>{if(e.ctrlKey||e.metaKey||e.shiftKey||e.altKey)return;let t=e.currentTarget;if(t._thetree?.preHandler?.(e)===!1||"_blank"===t.target)return;let a=t.getAttribute("href");if(!a||a.startsWith("#"))return;let r=new URL(t.href);r.origin===window.location.origin&&(void 0!==t.dataset.addRedirect&&(a+=`?redirect=${encodeURIComponent(window.location.pathname+window.location.search)}`),e.preventDefault(),await movePage(a))};function backupForm(){let e=content.querySelectorAll("form");for(let t of e)t.id&&(formBackup[t.id]=new FormData(t))}function restoreForm(e=!1,t=null){let a=t?[t]:content.querySelectorAll("form"),r=[];for(let n of a){let o=formBackup[n.id];if(o)for(let[s,l]of(r.push(n.id),o)){let i=n.querySelector(`input[name="${s}"], select[name="${s}"], textarea[name="${s}"]`);i&&"hidden"!==i.type&&("checkbox"===i.type||"radio"===i.type?i.checked=!!l:(e&&(l=i.getAttribute("value")??""),i._x_model?i._x_model.set(l):i.value=l),i.autofocus&&i.focus())}}for(let c of Object.keys(formBackup))r.includes(c)||delete formBackup[c]}function processFieldErrors(e,t={}){for(let a of e){if(!a.name)continue;let r=t[a.name],n;if(["DIV","SPAN","LABEL"].includes(a.parentElement?.tagName)){let o="LABEL"===a.parentElement.tagName,s=o?a.parentElement.parentElement:a.parentElement;(n=(o?s.parentElement:s).querySelector(`.input-error[data-for="${a.name}"]`))||!r||((n=document.createElement("p")).classList.add("input-error"),n.dataset.for=a.name,o?s.insertAdjacentElement("afterend",n):s.appendChild(n))}else a.nextElementSibling?.classList?.contains("input-error")?n=a.nextSibling:r&&((n=document.createElement("p")).classList.add("input-error"),a.after(n));n&&(r?n.textContent=r.msg:n.remove())}}const formBackup={},formHandler=async e=>{let t=e.currentTarget;if(t.dataset.noFormHandler||t._thetree?.submitting)return;if(e.preventDefault(),null!=t._thetree.captcha){for(let{reject:a}of captchaLock)a();captchaLock.length=0,captcha.reset(t._thetree.captcha),captcha.execute(t._thetree.captcha);try{await new Promise((e,t)=>{captchaLock.push({resolve:e,reject:t})})}catch(r){return}}increaseProgress(100),t._thetree.submitting=!0;let n=t.querySelectorAll('button:not([type="button"]):not([disabled])');for(let o of n)o.disabled=!0;let s=new FormData(t),l=new URL(t.action);"get"===t.method&&(l.search=new URLSearchParams(s).toString());let i="multipart/form-data"===t.enctype,c=await fetch(l,{method:t.method,..."get"===t.method?{}:{...i?{}:{headers:{"Content-Type":"application/x-www-form-urlencoded"}},body:i?s:new URLSearchParams(s).toString()}});for(let d of(t._thetree.submitting=!1,n))d.disabled=!1;backupForm();let u=t.querySelectorAll("input, select, textarea");if(204===c.status){restoreForm(!0,t),setProgress(100),plainAlert(),processFieldErrors(u);return}if(c.redirected){let p=e.target.parentElement.parentElement.parentElement;return p.classList.contains("thetree-modal")&&p._thetree.modal.close(!0),window.beforePageLoad=[],window.beforePopstate=null,await movePage(c)}let h=await c.text();if(c.status.toString().startsWith("4")){let m;try{(m=JSON.parse(h)).fieldErrors&&processFieldErrors(u,m.fieldErrors)}catch(g){}return(setProgress(100),m?.fieldErrors||h.startsWith("<"))?plainAlert():(processFieldErrors(u),h.includes("캡챠")&&(t.dataset.captcha="1",setupDocument(!0)),plainAlert(h))}c.status.toString().startsWith("5")&&location.reload(),await replaceContent(h,c.headers)?(setupDocument(),restoreForm(),changeUrl(c.url),plainAlert(),processFieldErrors(u)):plainAlert(h),setProgress(100)};function updateTimeTag(){let e=document.getElementsByTagName("time");for(let t of e){let a=t.dataset.type,r=new Date(t.dateTime);if("keep"===a)continue;let n=!1;if("relative"===a&&!State.getLocalConfig("wiki.no_relative_date")){let o=Date.now()-r.getTime(),s=durationToString(o);s&&(t.textContent=s,n=!0)}let l=getTimeStr(r);if("timezone"===a){let i=-(r.getTimezoneOffset()/60);l+=(i>0?"+":"-")+(100*i).toString().padStart(4,"0")}n?t.title=l:t.textContent=l}}function focusAnchor(){let e=location.hash.slice(1);if(e){let t;(t="toc"===e?document.getElementsByClassName("wiki-macro-toc")[0]:document.getElementById(e))&&t.scrollIntoView()}else window.scrollTo(0,0)}function setupUserText(){let e=document.getElementsByClassName("user-text-name");for(let t of e){if(t._thetree?.userTextInitialized)continue;let a=e=>(e.preventDefault(),State.userPopup.name=t.textContent,State.userPopup.uuid=t.dataset.uuid,State.userPopup.type=parseInt(t.dataset.type),State.userPopup.note=t.dataset.note||null,State.userPopup.isAdmin=!!t.dataset.admin,State.userPopup.threadAdmin=!!t.dataset.threadadmin,State.userPopup.open(t),!1);t._thetree??={},"A"===t.tagName&&t.removeEventListener("click",aClickHandler),t.addEventListener("click",a),t._thetree.userTextInitialized=!0}}let captchaOnLoadForm;function captchaOnLoad(){captcha=({recaptcha:window.grecaptcha,turnstile:window.turnstile})[CONFIG.captcha.type];let e=document.createElement("div");e.style.clear="both",captchaOnLoadForm.appendChild(e),captchaOnLoadForm._thetree.captcha=captcha.render(e,{sitekey:CONFIG.captcha.site_key,theme:State.currentTheme,callback(){for(let{resolve:e}of captchaLock)e();captchaLock.length=0},...{recaptcha:{badge:"inline",size:"invisible"},turnstile:{execution:"execute"}}[CONFIG.captcha.type]})}function setupDocument(e=!1){let t=document.getElementsByTagName("a");for(let a of t)a.getAttribute("@click")?.includes("aClickHandler")||(a.removeEventListener("click",aClickHandler),a.addEventListener("click",aClickHandler));let r=document.getElementsByTagName("form");for(let n of r)if(n.removeEventListener("submit",formHandler),n.addEventListener("submit",formHandler),n._thetree??={},CONFIG.captcha&&n.dataset.captcha&&(e||!State.session.disable_captcha)){if(captchaOnLoadForm=n,captchaLoaded)captchaOnLoad();else{let o=document.createElement("script");o.src=({recaptcha:"https://www.google.com/recaptcha/api.js?render=explicit&onload="+captchaOnLoad.name,turnstile:"https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit&onload="+captchaOnLoad.name})[CONFIG.captcha.type],document.head.appendChild(o),captchaLoaded=!0}}updateTimeTag(),focusAnchor(),window.beforePageLoad=[],window.beforePopstate=null;let s=document.getElementsByTagName("*");for(let l of s)"string"==typeof l.className&&l.className.includes("thetree")&&(l._thetree||(l._thetree={modal:{},dropdown:{},preHandler:null}));setupUserText(),emit("thetree:pageLoad")}function changeUrl(e){let t=new URL(e);if(t.pathname!==location.pathname||t.search!==location.search){let a=t.searchParams.get("anchor");if(a){let r=document.getElementById(a);r&&requestAnimationFrame(()=>r.scrollIntoView()),t.searchParams.delete("anchor"),t.hash=a}t.searchParams.delete("f"),history.pushState({},null,t.toString()),currentUrl=t.toString()}}let content,movePageAbortController;async function movePage(e,t=!0,a=null){if(window.beforePageLoad.length)for(let r of window.beforePageLoad){let n=await r();if(!n){a&&history.pushState({},null,a);return}}increaseProgress(100);let o="";if("string"==typeof e){let s=new URL(e,location.origin);s.hash&&(o=s.hash),s.searchParams.set("f","1"),movePageAbortController?.abort(),movePageAbortController=new AbortController;try{e=await fetch((e.startsWith("?")?"":s.pathname)+s.search,{signal:movePageAbortController.signal})}catch(l){if("AbortError"===l.name)return;console.error(l);return}}let i=await e.text();if(e.status.toString().startsWith("4")&&!i.startsWith("<"))return setProgress(100),plainAlert(i);if(plainAlert(),204===e.status)return setProgress(100);if(await replaceContent(i,e.headers))t&&changeUrl(e.url+o),setupDocument(),restoreForm();else{let c=new URL(e.url);c.hash=o,c.searchParams.delete("f"),location.href=e.url}setProgress(100)}function updateTitle(){document.title=page.data.document?`${doc_fulltitle(page.data.document)}${getTitleDescription(page)} - ${CONFIG.site_name}`:`${page.title} - ${CONFIG.site_name}`}const scriptCache={};async function replaceContent(html,headers){let result=!1,parser=new DOMParser,doc=parser.parseFromString(html,"text/html"),newContent,injectedStyles=[...document.querySelectorAll("link[data-injected]")],styles=doc.body.querySelectorAll('link[rel="stylesheet"]'),loadingStyles=styles.length,waitResolve,loadedStyles=[];for(let style of styles){style.remove(),loadedStyles.push(style.href);let dupStyle=injectedStyles.find(e=>e.href===style.href);if(dupStyle){loadingStyles--;continue}style.onload=()=>{0==--loadingStyles&&waitResolve?.()},style.dataset.injected="true",document.head.appendChild(style)}for(let style of(loadingStyles>0&&await waitUntil(new Promise(e=>{waitResolve=e}),5e3),injectedStyles))loadedStyles.includes(style.href)||style.remove();let fullReload=html.includes("<!DOCTYPE html>");if(fullReload){if("/member/mypage"===location.pathname)return location.reload();newContent=doc.getElementById("content"),document.body.innerHTML=doc.body.innerHTML,contentLoadedHandler(),result=!0}else html.includes("<")&&(newContent=doc,content.innerHTML=doc.body.innerHTML,result=!0);if(result){let csp=headers.get("Content-Security-Policy"),nonce=csp.split(" ").find(e=>e.startsWith("'nonce-")).slice(7,-1),allScripts=[...newContent.querySelectorAll("script")];for(let script of(fullReload&&allScripts.push(doc.getElementById("initScript")),allScripts)){if(script.src){let scriptText=scriptCache[script.src];if(!scriptText)try{let response=await fetch(script.src);if(!response.ok)continue;scriptText=await response.text(),scriptCache[script.src]=scriptText}catch(e){console.error(e),console.error("script fetch error, src:",script.src)}eval(scriptText)}else script.nonce===nonce&&eval(script.textContent);"initScript"===script.id&&(State.page=page,State.session=session)}updateTitle()}return result}function emit(e){let t=new CustomEvent(e);document.dispatchEvent(t)}let progressBar,progressInterval;function setProgress(e=0){progressInterval&&clearInterval(progressInterval),progressBar.classList.contains("done")&&progressBar.classList.remove("done"),progressBar.style.width=e+"%",100===e&&resetProgress()}function increaseProgress(e=0,t=3e3,a=100){progressInterval&&clearInterval(progressInterval),progressBar.classList.contains("done")&&progressBar.classList.remove("done");let r=parseFloat(progressBar.style.width)||0,n=e/(t/a);progressInterval=setInterval(()=>{r+=n,progressBar.style.width=r+"%",r>=e&&clearInterval(progressInterval)},a)}function progressTransitionEnd(e){"opacity"===e.propertyName&&(progressBar.classList.remove("done"),progressBar.style.width="0",progressBar.removeEventListener("transitionend",progressTransitionEnd))}function resetProgress(){progressBar.classList.add("done"),progressBar.addEventListener("transitionend",progressTransitionEnd)}window.addEventListener("beforeunload",e=>{if(window.beforePageLoad.length)for(let t of window.beforePageLoad){let a=t();a||e.preventDefault()}});const localConfig=JSON.parse(localStorage.getItem("thetree_settings")??"{}");document.addEventListener("alpine:init",()=>{Alpine.store("state",{page,session,localConfig,recent:[],aClickHandler,movePage,userPopup:{type:1,name:"",uuid:"",note:null,isAdmin:!1,threadAdmin:!1,deleted:!1,account:!1,blockable:!1,get typeStr(){if(0===parseInt(State.userPopup.type))return"IP";{let e="사용자";return State.userPopup.isAdmin?e+=" (관리자)":State.userPopup.threadAdmin&&(e+=" (전 관리자)"),e}},async block(){let e=State.userPopup.account;await State.openQuickACLGroup({username:e?State.userPopup.name:null,ip:e?null:State.userPopup.name,note:State.userPopup.note??void 0})},open(e){State.userPopup.deleted=-1===State.userPopup.type,State.userPopup.account=1===State.userPopup.type,State.userPopup.blockable=[0,1].includes(State.userPopup.type),requestAnimationFrame(()=>requestAnimationFrame(()=>{userPopup.classList.remove("popup-close"),FloatingUIDOM.computePosition(e,userPopup,{placement:"bottom-start",middleware:[FloatingUIDOM.offset(5),FloatingUIDOM.flip()]}).then(({x:e,y:t})=>{Object.assign(userPopup.style,{left:`${e}px`,top:`${t}px`})})}))},close(){userPopup.classList.add("popup-close")}},threadPopup:{comment:null,open(e,t){let a=document.getElementById("threadpopup");a&&(State.threadPopup.comment=e,requestAnimationFrame(()=>requestAnimationFrame(()=>{a.classList.remove("popup-close"),FloatingUIDOM.computePosition(t,a,{placement:"bottom-end",middleware:[FloatingUIDOM.offset(6),FloatingUIDOM.flip()]}).then(({x:e,y:t})=>{Object.assign(a.style,{left:`${e}px`,top:`${t}px`})})})))},close(){let e=document.getElementById("threadpopup");e&&e.classList.add("popup-close")},async toggleRaw(){let e=State.threadPopup.comment;if(!e.rawHtml){let t=await fetch(`/admin/thread/${State.page.data.thread.url}/${State.threadPopup.comment.id}/raw`),a=await t.text();if(!t.ok)return alert(a);let r=document.createElement("div");r.classList.add("wiki-raw"),r.innerText=a,e.rawHtml=r.outerHTML}e.seeRaw=!e.seeRaw,e.forceShow=!0},async hide(){await fetch(`/admin/thread/${State.page.data.thread.url}/${State.threadPopup.comment.id}/hide`,{method:"POST"})},async show(){await fetch(`/admin/thread/${State.page.data.thread.url}/${State.threadPopup.comment.id}/show`,{method:"POST"})}},threadIntersectionObserver:new IntersectionObserver(async e=>{let t=!1;for(let a of e){let r=a.target.parentElement;a.isIntersecting?(r.classList.add("comment-block-visible"),t=!0):r.classList.remove("comment-block-visible")}t&&window.dispatchEvent(new Event("scroll"))}),async openQuickACLGroup({username:e=null,ip:t=null,note:a="긴급차단"}={}){quickBlockGroupSelect.innerHTML="",quickBlockGroupSelect.disabled=!0,quickBlockMode.value=null==e?"ip":"username",quickBlockMode.dispatchEvent(new Event("change")),quickBlockTarget.value=e??t,quickBlockNote.value=a,quickBlockDuration.value="0",quickBlockModal.querySelector(".thetree-alert").hidden=!0,quickBlockModal.querySelectorAll(".input-error").forEach(e=>e.remove()),quickBlockModal._thetree.modal.open();let r=await fetch("/aclgroup/groups"),n=await r.json();for(let o of n){let s=document.createElement("option");s.value=o.uuid,s.textContent=o.name,quickBlockGroupSelect.appendChild(s)}quickBlockGroupSelect.disabled=!1},settingSelectedTab:null,openSettingModal(){State.selectSettingTab("wiki",!0),settingModal._thetree.modal.open()},selectSettingTab(e,t=!1){if(e===State.settingSelectedTab)return;State.settingSelectedTab=e;let a=settingModalContent.getElementsByClassName("selected-tab-content")[0];if(!t&&!a)return;a?.classList.remove("selected-tab-content");let r=()=>{a?.classList.remove("setting-tab-leave");let e=document.getElementById("setting-tab-"+State.settingSelectedTab);e.classList.add("selected-tab-content")};t?r():(a.classList.add("setting-tab-leave"),a.addEventListener("transitionend",r))},async init(){setInterval(()=>this.updateSidebar(),3e4),await this.updateSidebar()},async updateSidebar(){let e=await fetch("/sidebar.json");this.recent=await e.json()},getLocalConfig(e){return this.localConfig[e]??defaultConfig[e]},setLocalConfig(e,t){this.localConfig[e]=t,localStorage.setItem("thetree_settings",JSON.stringify(this.localConfig)),emit("thetree:configChange"),"wiki.no_relative_date"===e&&updateTimeTag()},get currentTheme(){let t=this.getLocalConfig("wiki.theme");return"auto"===t&&(t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),t}}),window.State=Alpine.store("state"),Alpine.data("search",()=>({searchFocused:!1,lastSearchText:"",searchText:"",cursor:-1,internalItems:[],searchAbortController:null,wait:50,searchTimeout:null,get show(){return this.searchFocused&&this.searchText.length>0&&this.internalItems.length>0},blur(){setTimeout(()=>{this.searchFocused=!1},100)},focus(){this.searchFocused=!0},inputChange(){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(async()=>{if(this.searchText!==this.lastSearchText){if(this.lastSearchText=this.searchText,!this.searchText.length){this.internalItems=[];return}this.searchAbortController&&this.searchAbortController.abort();try{this.searchAbortController=new AbortController;let e=await fetch(`/Complete?q=${encodeURIComponent(this.searchText)}`,{signal:this.searchAbortController.signal});this.internalItems=await e.json(),this.cursor=-1}catch(t){}}},this.wait)},async onClickItem(e){await movePage(`/Go?q=${encodeURIComponent(e)}`)},async keyEnter(e){e.preventDefault();let t=this.internalItems[this.cursor];if(t)await this.onClickItem(t);else{if(!this.searchText)return;await movePage(`/Go?q=${encodeURIComponent(this.searchText)}`)}e.srcElement.blur()},keyUp(){this.cursor>=0&&this.cursor--},keyDown(){this.cursor<this.internalItems.length&&this.cursor++},async onClickSearch(e){e.preventDefault(),this.searchText&&(e.srcElement.blur(),await movePage(`/Search?q=${encodeURIComponent(this.searchText)}`))},async onClickMove(e){e.preventDefault(),this.searchText&&(e.srcElement.blur(),await movePage(doc_action_link(this.searchText,"w")))}}))}),window.addEventListener("load",()=>{let e=document.body.querySelectorAll('link[rel="stylesheet"]');for(let t of e)t.remove(),t.dataset.injected="true",document.head.appendChild(t)}),window.addEventListener("keypress",async e=>{if(!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&("c"===e.key&&await movePage("/RecentChanges"),"d"===e.key&&await movePage("/RecentDiscuss"),"a"===e.key&&await movePage("/random"),"f"===e.key&&await movePage(`/w/${CONFIG.front_page}`),"e"===e.key)){let t=State.page.data.document;t&&await movePage(doc_action_link(t,"edit"))}});