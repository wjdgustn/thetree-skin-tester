function setupComment(){setupUserText(),setupWikiHandlers()}document.addEventListener("thetree:pageLoad",()=>{let e=State.page.data,t,n=[],m=!1,d=()=>{t=setTimeout(async()=>{m&&await waitUntil(new Promise(e=>{n.push(e)}),5e3);let t=[...document.getElementsByClassName("comment-block-visible")],o=t.find(e=>!e.dataset.fetched);if(!o)return;m=!0;let s=o.dataset.index,a=e.comments[s],c=0,i=e.comments.find(e=>e.id>a.id&&e.userHtml),l=e.comments[e.comments.length-1],r=(i??l).id-a.id+(i?-1:1);c+=e.commentLoadAmount-Math.min(e.commentLoadAmount,r);let u=e.comments.find(e=>!e.userHtml&&e.id>=a.id-c),h=await fetch(`/thread/${e.thread.url}/${u.id}`),f=await h.json();for(let p of f){let $=e.comments.findIndex(e=>e.id===p.id);-1!==$?e.comments[$]=p:e.comments.push(p)}m=!1,n.forEach(e=>e()),requestAnimationFrame(()=>{setupComment();let e=[...document.getElementsByClassName("comment-block-visible")],t=e.find(e=>!e.dataset.fetched);t&&d()})},100)},o=()=>{null!=t&&clearTimeout(t),d()};d(),window.addEventListener("scroll",o);let s=io("/thread",{query:{thread:e.thread.url}});s.on("comment",t=>{let n=e.comments.findIndex(e=>e.id===t.id),m=e.comments[n];-1!==n?e.comments[n]=t:e.comments.push(t),m?.contentHtml&&(t.contentHtml=m.contentHtml),requestAnimationFrame(()=>{setupComment()})}),s.on("updateThread",async t=>{if(t.deleted)return await movePage(doc_action_link(page.data.document,"discuss"));e.thread={...e.thread,...t},t.topic&&updateTitle()}),window.beforePageLoad.push(()=>(window.removeEventListener("scroll",o),s.disconnect(),!0)),o()},{once:!0});